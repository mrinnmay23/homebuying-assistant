<!--<!DOCTYPE html>-->
<!--<html xmlns:th="http://www.thymeleaf.org">-->
<!--<head>-->
<!--    <meta charset="UTF-8" />-->
<!--    <title>Mortgage Chatbot</title>-->
<!--</head>-->
<!--<body>-->
<!--<h1>Mortgage Chatbot</h1>-->
<!--<a th:href="@{/}">&larr; Home</a>-->
<!--<form id="chat-form">-->
<!--    <input-->
<!--            type="text"-->
<!--            id="msg"-->
<!--            placeholder="Type your question…"-->
<!--            autocomplete="off"-->
<!--            style="width: 300px;"-->
<!--    />-->
<!--    <button type="submit">Send</button>-->
<!--</form>-->

<!--<pre id="log" style="margin-top: 1em; background: #f5f5f5; padding: 1em;"></pre>-->

<!--&lt;!&ndash; inline script to catch the submit and POST via fetch &ndash;&gt;-->
<!--<script th:inline="javascript">-->
<!--    /*<![CDATA[*/-->
<!--    const form = document.getElementById('chat-form');-->
<!--    const log  = document.getElementById('log');-->

<!--    form.addEventListener('submit', async (e) => {-->
<!--        e.preventDefault();                          // stop real navigation-->
<!--        const msg = document.getElementById('msg').value.trim();-->
<!--        if (!msg) return;-->

<!--        // show user message-->
<!--        log.textContent += `You: ${msg}\n`;-->

<!--        // fire a POST /api-->
<!--        const resp = await fetch(/*[[ @{/api} ]]*/, {-->
<!--            method: 'POST',-->
<!--            headers: { 'Content-Type': 'application/json' },-->
<!--            body: JSON.stringify({ message: msg })-->
<!--        });-->

<!--        const body = await resp.json();-->
<!--        log.textContent += `Bot: ${JSON.stringify(body)}\n\n`;-->


<!--        // clear input-->
<!--        document.getElementById('msg').value = '';-->
<!--    });-->
<!--    /*]]>*/-->
<!--</script>-->
<!--</body>-->
<!--</html>-->





<!--<!DOCTYPE html>-->
<!--<html xmlns:th="http://www.thymeleaf.org" lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8" />-->
<!--    <title>Mortgage Chatbot</title>-->
<!--    &lt;!&ndash; Bootswatch Cosmo theme &ndash;&gt;-->
<!--    <link-->
<!--            href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/cosmo/bootstrap.min.css"-->
<!--            rel="stylesheet"-->
<!--            crossorigin="anonymous"-->
<!--    />-->
<!--    <style>-->
<!--        body {-->
<!--            background: url('/images/background5.jpg') no-repeat center center fixed;-->
<!--            background-size: cover;-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body class="bg-light">-->

<!--&lt;!&ndash; navbar &ndash;&gt;-->
<!--&lt;!&ndash;<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">&ndash;&gt;-->
<!--<nav class="navbar navbar-expand-lg bg-transparent mb-4">-->
<!--    <div class="container">-->
<!--        <a class="navbar-brand" th:href="@{/}">Homebuying Assistant</a>-->
<!--        <div class="navbar-nav">-->
<!--            <a class="nav-link active" th:href="@{/chat}">Chat</a>-->
<!--            <a class="nav-link" th:href="@{/quotes}">Quotes</a>-->
<!--            <a class="nav-link" th:href="@{/calculator}">Calculator</a>-->
<!--            &lt;!&ndash; etc… &ndash;&gt;-->
<!--        </div>-->
<!--    </div>-->
<!--</nav>-->

<!--<div class="container">-->

<!--    &lt;!&ndash; back to home &ndash;&gt;-->
<!--    <a th:href="@{/}" class="btn btn-outline-secondary mb-3">-->
<!--        ← Home-->
<!--    </a>-->

<!--    <h1 class="mb-4">Mortgage Chatbot</h1>-->

<!--    &lt;!&ndash; translucent panel &ndash;&gt;-->
<!--    <div class="p-4 mb-4 bg-white bg-opacity-75 rounded shadow-sm">-->

<!--        &lt;!&ndash; optional GIF avatar: place chatbot.gif in src/main/resources/static/images/ &ndash;&gt;-->
<!--        <div class="text-center mb-4">-->
<!--            <img-->
<!--                    th:src="@{/images/chatbot.gif}"-->
<!--                    alt="Chatbot Avatar"-->
<!--                    class="img-fluid"-->
<!--                    style="max-height: 200px;"-->
<!--            />-->
<!--        </div>-->

<!--        &lt;!&ndash; chat input &ndash;&gt;-->
<!--        <form id="chat-form" class="row g-2 mb-3">-->
<!--            <div class="col">-->
<!--                <input-->
<!--                        type="text"-->
<!--                        id="msg"-->
<!--                        class="form-control"-->
<!--                        placeholder="Type your question…"-->
<!--                        autocomplete="off"-->
<!--                />-->
<!--            </div>-->
<!--            <div class="col-auto">-->
<!--                <button type="submit" class="btn btn-primary">Send</button>-->
<!--            </div>-->
<!--        </form>-->

<!--        &lt;!&ndash; chat log &ndash;&gt;-->
<!--        <div-->
<!--                id="log"-->
<!--                class="border rounded p-3"-->
<!--                style="height: 300px; overflow-y: auto; background: #f8f9fa;"-->
<!--        ></div>-->

<!--    </div>-->
<!--    &lt;!&ndash; /translucent panel &ndash;&gt;-->

<!--</div>-->

<!--&lt;!&ndash; chat‐post script &ndash;&gt;-->
<!--<script th:inline="javascript">-->
<!--    /*<![CDATA[*/-->
<!--    const form = document.getElementById('chat-form');-->
<!--    const log  = document.getElementById('log');-->

<!--    form.addEventListener('submit', async e => {-->
<!--        e.preventDefault();-->
<!--        const msg = document.getElementById('msg').value.trim();-->
<!--        if (!msg) return;-->

<!--        // append user message-->
<!--        log.innerHTML += `<div><strong>You:</strong> ${msg}</div>`;-->

<!--        // call backend-->
<!--        const resp = await fetch(/*[[ @{/api} ]]*/, {-->
<!--            method: 'POST',-->
<!--            headers: { 'Content-Type': 'application/json' },-->
<!--            body: JSON.stringify({ message: msg })-->
<!--        });-->
<!--        const body = await resp.json();-->
<!--        const reply = body.reply || JSON.stringify(body);-->

<!--        // append bot reply-->
<!--        log.innerHTML += `<div><strong>Bot:</strong> ${reply}</div>`;-->

<!--        // scroll to bottom-->
<!--        log.scrollTop = log.scrollHeight;-->

<!--        // clear input-->
<!--        document.getElementById('msg').value = '';-->
<!--    });-->
<!--    /*]]>*/-->
<!--</script>-->

<!--</body>-->
<!--</html>-->






<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Mortgage Chatbot</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/cosmo/bootstrap.min.css"
            rel="stylesheet"
            crossorigin="anonymous"
    />
    <style>
        body{
            background: url('/images/background2.jpg') no-repeat center center fixed;
            background-size: cover;
        }
    </style>
</head>
<body class="bg-light">

<!-- transparent navbar (kept as-is) -->
<nav class="navbar navbar-expand-lg bg-transparent mb-4">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">Homebuying Assistant</a>
        <div class="navbar-nav">
            <a class="nav-link active" th:href="@{/chat}">Chat</a>
            <a class="nav-link" th:href="@{/quotes}">Quotes</a>
            <a class="nav-link" th:href="@{/calculator}">Calculator</a>
        </div>
    </div>
</nav>

<div class="container">
    <a th:href="@{/}" class="btn btn-outline-secondary mb-3">← Home</a>
    <h1 class="mb-4">Mortgage Chatbot</h1>

    <!-- translucent panel -->
    <div class="p-4 mb-4 bg-white bg-opacity-75 rounded shadow-sm">

        <!-- avatar GIF (optional) -->
        <div class="text-center mb-4">
            <img th:src="@{/images/chatbot.gif}" alt="Chatbot Avatar"
                 class="img-fluid" style="max-height: 160px;" />
        </div>

        <!-- ADDED: PDF upload to feed the chat context -->
        <form id="pdf-form" enctype="multipart/form-data" class="row g-2 mb-4">
            <div class="col">
                <input class="form-control" type="file" name="file" accept="application/pdf" required />
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-primary" type="submit">Attach PDF to Chat</button>
            </div>
        </form>

        <!-- chat input -->
        <form id="chat-form" class="row g-2 mb-3">
            <div class="col">
                <input type="text" id="msg" class="form-control"
                       placeholder="Type your question…" autocomplete="off" />
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Send</button>
            </div>
        </form>

        <!-- chat log -->
        <div id="log" class="border rounded p-3"
             style="height: 320px; overflow-y: auto; background:#f8f9fa;"></div>

    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const log  = document.getElementById('log');
    const AGENT_IMG_BASE = /*[[@{/images/}]]*/ '/images/';

    // ---------- helper to append lines ----------
    function say(who, html){
        const line = document.createElement('div');
        line.innerHTML = `<strong>${who}:</strong> ${html}`;
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
    }

    // ---------- CHAT: POST /api ----------
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('msg').value.trim();
        if (!msg) return;
        say('You', msg);

        const resp = await fetch(/*[[ @{/api} ]]*/, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg })
        });
        const body = await resp.json();

        // show either a plain reply or a summarized JSON
        if (body.reply) {
            say('Bot', body.reply);
        } else if (body.monthlyPayment) {
            say('Bot', `Monthly payment: $${Number(body.monthlyPayment).toFixed(2)}`);
        } else if (body.percentile) {
            say('Bot', `Your offer is at the ${Number(body.percentile).toFixed(1)}th percentile.`);
        } else if (body.quotes) {
            say('Bot', 'Here are your quotes:');
            const ul = document.createElement('ul');
            ul.style.marginTop = '6px';
            (body.quotes || []).forEach(q => {
                const li = document.createElement('li');
                li.textContent = `Rate ${q.rate}% | Fees ${q.fees} | Score range ${q.minScore}-${q.maxScore} `;
                ul.appendChild(li);
            });
            log.appendChild(ul);
            log.scrollTop = log.scrollHeight;
        } else if (body.schedule) {
            say('Bot', 'Amortization (first 5 years):');
            const first = (body.schedule || []).slice(0,5);
            const table = document.createElement('table');
            table.className = 'table table-sm';
            table.innerHTML = `
      <thead><tr><th>Year</th><th>Principal</th><th>Interest</th><th>Balance</th></tr></thead>
      <tbody>
        ${first.map(r => `
          <tr>
            <td>${r.year}</td>
            <td>${r.principalPaid}</td>
            <td>${r.interestPaid}</td>
            <td>${r.remainingBalance}</td>
          </tr>`).join('')}
      </tbody>`;
            log.appendChild(table);
            log.scrollTop = log.scrollHeight;
        } else if (body.refinance) {
            const r = body.refinance;
            say('Bot', `Old: $${r.oldPayment} → New: $${r.newPayment} | Save $${r.monthlySavings}/mo | Should refinance? ${r.shouldRefinance ? 'Yes' : 'No'}`);
        } else if (body.agent) {
            // NEW: pretty render agent instead of dumping JSON
            const a = body.agent;
            const card = document.createElement('div');
            card.className = 'card mb-2';
            card.innerHTML = `
              <div class="card-body d-flex align-items-center gap-3">
                ${a.imageFilename ? `<img src="/images//${a.imageFilename}" alt="${a.name}" class="rounded-circle" style="width:64px;height:64px;object-fit:cover;">` : ''}
                <div>
                  <div class="fw-semibold">${a.name} (ID ${a.id})</div>
                  <div>
                    <a href="mailto:${a.email}">${a.email}</a>
                    &nbsp;·&nbsp;
                    <a href="tel:${a.phone}">${a.phone}</a>
                  </div>
                </div>
              </div>`;
            log.appendChild(card);
            log.scrollTop = log.scrollHeight;
        } else {
            say('Bot', `<pre class="mb-0">${JSON.stringify(body, null, 2)}</pre>`);
        }

        document.getElementById('msg').value = '';
    });

    // ---------- PDF TO CHAT CONTEXT: POST /api/pdf/upload-to-chat ----------
    document.getElementById('pdf-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        say('You', '[uploaded a Loan Estimate PDF]');
        const fd = new FormData(e.target);

        const resp = await fetch(/*[[ @{/api/pdf/upload-to-chat} ]]*/, {
            method: 'POST',
            body: fd
        });
        const json = await resp.json();

        if (json.error) {
            say('Bot', `<span class="text-danger">${json.error}</span>`);
            return;
        }

        const n = json.normalized || {};
        const have = [
            n.principal != null ? `amount=$${n.principal}` : null,
            n.rate != null ? `rate=${n.rate}%` : null,
            n.termYears != null ? `term=${n.termYears}y` : null,
            n.fees != null ? `fees=$${n.fees}` : null
        ].filter(Boolean).join(', ');

        say('Bot', json.reply || 'PDF processed.');
        if (have) say('Bot', `Saved from PDF → ${have}`);
        e.target.reset();
    });
    /*]]>*/
</script>
</body>
</html>

